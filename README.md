# Arduino-RN42
ArduinoとRN42を２台使ったArduino同士のBluetooth通信の方法

---

## 1. 事前準備：ハードウェアの構築

RN42は3.3V駆動のモジュールです。Arduino（5V系）と接続する際は、電圧レベルの違いに注意が必要です。

### 配線図

各ユニット（Master側・Slave側共通）で以下の配線を行います。

* **RN42 VCC**: Arduino **3.3V** へ
* **RN42 GND**: Arduino **GND** へ
* **RN42 TX**: Arduino **Pin 10 (RX)** へ
* **RN42 RX**: Arduino **Pin 11 (TX)** へ（**※抵抗分圧が必要**）
* Arduino(5V)の信号を3.3Vに落とすため、10kΩと20kΩ程度の抵抗で分圧して接続してください。



---

## 2. RN42の初期設定（ATコマンド）

2台を自動接続させるために、片方を「Master（親）」、もう片方を「Slave（子）」として設定します。

### 設定用スケッチ

以下のコードを両方のArduinoに書き込み、シリアルモニタ（改行なし設定）からコマンドを送ります。

```cpp
#include <SoftwareSerial.h>
SoftwareSerial mySerial(10, 11); // RX, TX

void setup() {
  Serial.begin(9600);
  mySerial.begin(115200); // RN42のデフォルト。不安定なら9600へ変更
}

void loop() {
  if (mySerial.available()) Serial.write(mySerial.read());
  if (Serial.available()) mySerial.write(Serial.read());
}

```

### 設定手順

1. **コマンドモードへの進入**: `$$$` を入力（応答: `CMD`）
* **重要**: 前後に1秒間の無入力時間を置くこと。


2. **Slave側の設定**:
* `GB` を入力して表示される12桁のMACアドレス（例: `0006666XXXXX`）をメモする。
* `SM,0` (Slaveモード) を入力。


3. **Master側の設定**:
* `SM,3` (自動接続モード) を入力。
* `SR,0006666XXXXX` (先ほどメモしたSlaveのMACアドレス) を入力。


4. **終了**: 両方で `---` を入力して終了。

---

## 3. 双方向通信と同期の実装

接続が完了すると、シリアル通信（`print`や`read`）を行うだけで、無線でデータがやり取りされます。

### 同期のアルゴリズム

複数のモーターを2台のArduinoで連携させる場合、以下の「トリガー送信方式」が有効です。

* **送信側 (Main)**: 特定の動作（例：掘削）に入る直前に `BTSerial.print('G');` を送信。
* **受信側 (Orga)**: `while` 文で受信を待ち、`'G'` が来たら自身の動作ルーチンを開始。

```cpp
// 受信側の待機ロジック例
while (true) {
  if (BTSerial.available()) {
    if (BTSerial.read() == 'G') break; // 開始信号でループを抜ける
  }
}
// ここからモーター動作を開始

```

---

## 4. 注意事項・トラブルシューティング

* **SoftwareSerialの限界**:
ArduinoのSoftwareSerialは115200bpsでは通信が化けやすいです。コマンドモードで `U,9600,N` を実行し、RN42自体のボーレートを **9600bps** に下げて運用するのが最も安定します。
* **接続確認**:
RN42のステータスLEDを確認してください。高速点滅は「接続待機」、2秒に1回の点滅（または点灯）は「接続完了」を意味します。
* **電力不足**:
モータードライバと同時に動かす場合、電力不足でBluetoothが切断されることがあります。Arduinoの3.3Vピンではなく、容量の大きいレギュレータからRN42の電源を取ることを検討してください。

---

## 次のステップ

通信が安定したら、次は「チェックサム」や「特定の終了文字（`\n`など）」を導入して、より複雑な数値データ（センサー値など）を送受信できるシステムにアップグレードしてみましょう。

まとめについて、さらに詳細を知りたい箇所や、追加したい項目はありますか？
